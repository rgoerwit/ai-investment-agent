# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âš ï¸  âš ï¸  âš ï¸  DO NOT RUN THIS WORKFLOW WITHOUT EDITING IT FIRST! âš ï¸  âš ï¸  âš ï¸
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# This is a REFERENCE IMPLEMENTATION for Terraform-based Azure deployment.
# It is provided as a STARTING POINT and WILL NOT WORK without customization.
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ONLY USE THIS IF:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# âœ“ You want to deploy this trading system to Azure Container Instances
# âœ“ You are using Terraform to manage infrastructure as code
# âœ“ You have an Azure subscription and are familiar with Azure concepts
# âœ“ You understand GitHub Actions workflows and secrets management
# âœ“ You are comfortable editing YAML and Terraform configurations
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BEFORE RUNNING THIS WORKFLOW, YOU MUST:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. Create terraform/environments/dev/, staging/, prod/ directories
#    - Each should contain your Terraform .tf files
#    - Configure backend.tf for your Azure storage account
#    - Customize resource names, regions, and sizing
#
# 2. Update this file:
#    - Line 59: REGISTRY_NAME - change to YOUR Azure Container Registry name
#    - Lines 150+: Adjust resource group names, locations, etc.
#    - Review ALL environment variable names (TF_VAR_*)
#
# 3. Create GitHub Secrets (Settings â†’ Secrets and variables â†’ Actions):
#    - ARM_CLIENT_ID: Your Azure service principal's client ID
#    - ARM_CLIENT_SECRET: Your service principal's secret
#    - ARM_TENANT_ID: Your Azure AD tenant ID  
#    - ARM_SUBSCRIPTION_ID: Your Azure subscription ID
#    - GOOGLE_API_KEY: Your Google Gemini API key
#    - TAVILY_API_KEY: (Optional) Tavily search API key
#    - FMP_API_KEY: (Optional) Financial Modeling Prep API key
#    - LANGSMITH_API_KEY: (Optional) LangSmith tracing key
#
# 4. Create GitHub Environments (Settings â†’ Environments):
#    - dev (recommended: no protection rules for fast iteration)
#    - staging (recommended: require 1 reviewer)
#    - prod (STRONGLY recommended: require 2+ reviewers)
#
# 5. Test in dev environment FIRST:
#    - Run with environment=dev, action=plan-only
#    - Review the plan carefully
#    - Only then try action=apply
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# EXPECTED COSTS (APPROXIMATE):
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# - Azure Container Instance (1 vCPU, 1.5GB RAM): ~$30-45/month per environment
# - Azure Container Registry (Basic tier): ~$5/month
# - Azure Storage (for Terraform state): ~$1-2/month
# - API costs: Variable (Gemini free tier covers ~100 stocks/day)
#
# Total estimated: $40-55/month for a single environment
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# SUPPORT AND DISCLAIMER:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# This workflow is provided AS-IS as a learning reference.
# - It reflects ONE possible deployment architecture
# - Your needs may differ significantly
# - No warranty or support is provided
# - You are responsible for Azure costs and security
# - Always test in dev before deploying to production!
#
# If you don't understand what this workflow does, DO NOT run it.
# Consider running the system locally first to understand its behavior.
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "[EXPERIMENTAL] Terraform Infrastructure"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# MANUAL TRIGGER ONLY - This workflow NEVER runs automatically
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (CUSTOMIZE terraform/ directory structure first!)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - plan-only
          - apply

# Set minimal permissions for Azure deployment (principle of least privilege)
permissions:
  id-token: write        # Required for Azure OIDC authentication (federated credentials)
  contents: read         # Required to checkout code and read Terraform configs
  pull-requests: write   # Required to comment deployment status on PRs

env:
  REGISTRY_NAME: tradingsystem  # âš ï¸  CHANGE THIS! Use your own Azure Container Registry name
  IMAGE_NAME: trading-system

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Preflight safety checks - Validates configuration before attempting deploy
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  preflight-check:
    runs-on: ubuntu-latest
    steps:
      - name: "âš ï¸  CRITICAL WARNING BANNER âš ï¸"
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  âš ï¸  âš ï¸        THIS IS AN EXPERIMENTAL WORKFLOW!        âš ï¸  âš ï¸  âš ï¸"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "You are about to deploy infrastructure to Azure using Terraform."
          echo ""
          echo "BEFORE PROCEEDING, VERIFY THAT YOU HAVE:"
          echo "  âœ“ Read ALL comments at the top of this workflow file"
          echo "  âœ“ Created terraform/environments/${{ github.event.inputs.environment }}/ with your .tf files"
          echo "  âœ“ Customized resource names, regions, and sizes for YOUR needs"
          echo "  âœ“ Configured ALL required GitHub secrets"
          echo "  âœ“ Set up GitHub Environments with appropriate protection rules"
          echo "  âœ“ Changed REGISTRY_NAME on line 59 to YOUR Azure Container Registry"
          echo "  âœ“ Reviewed ALL TF_VAR_* environment variable names"
          echo "  âœ“ Tested this workflow in 'dev' environment first"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Target Environment: ${{ github.event.inputs.environment }}"
          echo "Action: ${{ github.event.inputs.action }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "This workflow will incur Azure costs. You are responsible for all charges."
          echo ""
          echo "Proceeding in 10 seconds... Press Ctrl+C in Actions UI to cancel!"
          sleep 10
          echo ""
          echo "âœ“ Preflight warning acknowledged, continuing with deployment checks..."

      - name: Validate Required Secrets
        run: |
          missing_secrets=()
          
          if [ -z "${{ secrets.ARM_CLIENT_ID }}" ]; then
            missing_secrets+=("ARM_CLIENT_ID")
          fi
          
          if [ -z "${{ secrets.ARM_CLIENT_SECRET }}" ]; then
            missing_secrets+=("ARM_CLIENT_SECRET")
          fi
          
          if [ -z "${{ secrets.ARM_TENANT_ID }}" ]; then
            missing_secrets+=("ARM_TENANT_ID")
          fi
          
          if [ -z "${{ secrets.ARM_SUBSCRIPTION_ID }}" ]; then
            missing_secrets+=("ARM_SUBSCRIPTION_ID")
          fi
          
          if [ -z "${{ secrets.GOOGLE_API_KEY }}" ]; then
            missing_secrets+=("GOOGLE_API_KEY")
          fi
          
          if [ ${#missing_secrets[@]} -ne 0 ]; then
            echo "âŒ Missing required secrets: ${missing_secrets[*]}"
            echo ""
            echo "Configure these in: Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

  # Optional: Build container image
  build-container:
    runs-on: ubuntu-latest
    needs: [preflight-check]
    if: github.event.inputs.action == 'apply'
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ env.REGISTRY_NAME }}${{ github.event.inputs.environment }}.azurecr.io
          username: ${{ secrets.ARM_CLIENT_ID }}
          password: ${{ secrets.ARM_CLIENT_SECRET }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY_NAME }}${{ github.event.inputs.environment }}.azurecr.io/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=${{ github.event.inputs.environment }}-
            type=raw,value=${{ github.event.inputs.environment }}-latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # Terraform validation
  terraform-validate:
    runs-on: ubuntu-latest
    needs: [preflight-check]
    steps:
      - uses: actions/checkout@v4
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Check Terraform Directory Exists
        run: |
          if [ ! -d "terraform/environments/${{ github.event.inputs.environment }}" ]; then
            echo "âŒ Directory not found: terraform/environments/${{ github.event.inputs.environment }}"
            echo ""
            echo "Create this directory with your Terraform configuration first!"
            exit 1
          fi
          echo "âœ… Terraform directory exists"
      
      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check -recursive || echo "âš ï¸  Format issues found (non-blocking)"
      
      - name: Terraform Init (validation only)
        working-directory: terraform/environments/${{ github.event.inputs.environment }}
        run: terraform init -backend=false
      
      - name: Terraform Validate
        working-directory: terraform/environments/${{ github.event.inputs.environment }}
        run: terraform validate

  # Generate Terraform plan
  terraform-plan:
    runs-on: ubuntu-latest
    needs: [preflight-check, terraform-validate]
    steps:
      - uses: actions/checkout@v4
      
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
          terraform_wrapper: false
      
      - name: Terraform Init
        working-directory: terraform/environments/${{ github.event.inputs.environment }}
        run: terraform init
      
      - name: Terraform Plan
        working-directory: terraform/environments/${{ github.event.inputs.environment }}
        env:
          TF_VAR_google_api_key: ${{ secrets.GOOGLE_API_KEY }}
          TF_VAR_tavily_api_key: ${{ secrets.TAVILY_API_KEY }}
          TF_VAR_fmp_api_key: ${{ secrets.FMP_API_KEY }}
          TF_VAR_langsmith_api_key: ${{ secrets.LANGSMITH_API_KEY }}
        run: |
          terraform plan -detailed-exitcode -out=tfplan.binary || export TF_PLAN_EXIT_CODE=$?
          
          # Generate human-readable plan
          terraform show -no-color tfplan.binary > tfplan.txt
          
          echo "## ğŸ“‹ Terraform Plan Output"
          echo ""
          cat tfplan.txt
          
          if [ "${TF_PLAN_EXIT_CODE:-0}" -eq 0 ]; then
            echo ""
            echo "âœ… No changes detected"
          elif [ "${TF_PLAN_EXIT_CODE:-0}" -eq 2 ]; then
            echo ""
            echo "ğŸ“‹ Changes detected - review plan above"
          else
            echo "âŒ Plan failed with exit code ${TF_PLAN_EXIT_CODE}"
            exit 1
          fi
      
      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment }}-${{ github.sha }}
          path: terraform/environments/${{ github.event.inputs.environment }}/tfplan.binary
          retention-days: 7

  # Apply Terraform - requires explicit "apply" action selection
  terraform-apply:
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'apply'
    needs: [terraform-plan, build-container]
    environment: 
      name: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0
      
      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan-${{ github.event.inputs.environment }}-${{ github.sha }}
          path: terraform/environments/${{ github.event.inputs.environment }}/
      
      - name: Terraform Init
        working-directory: terraform/environments/${{ github.event.inputs.environment }}
        run: terraform init
      
      - name: Final Confirmation
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âš ï¸  ABOUT TO APPLY TERRAFORM CHANGES"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Proceeding with apply in 10 seconds..."
          echo "Press Ctrl+C to cancel!"
          sleep 10
      
      - name: Terraform Apply
        working-directory: terraform/environments/${{ github.event.inputs.environment }}
        run: terraform apply -auto-approve tfplan.binary
      
      - name: Output Deployment Info
        working-directory: terraform/environments/${{ github.event.inputs.environment }}
        run: |
          echo "ğŸš€ Deployment completed!"
          terraform output